name: MTT SEASON UPDATE V5

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-races:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        pip install requests supabase

    - name: Scrape & Parse Data
      run: |
        python mtt_api_scraper.py
        python parse_gare_file.py

    - name: Upload Data to Supabase
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: python upload_data.py

    - name: Trigger Vercel Redeploy (Optional)
      run: |
        if [[ "${{ secrets.VERCEL_DEPLOY_HOOK }}" != "" ]]; then
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
        fi
